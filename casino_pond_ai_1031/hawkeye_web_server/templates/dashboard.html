<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CASINO Hawkeye Analysis Dashboard</title>
    <link rel="stylesheet" href="/static/css/common.css">
    <link rel="stylesheet" href="/static/css/dashboard.css">
</head>
<body>
    <!-- Run Details Modal -->
    <div id="runDetailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Run Details</h2>
                <button class="modal-close" onclick="closeRunDetailsModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Content will be loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeRunDetailsModal()" style="background: #95a5a6;">Close</button>
            </div>
        </div>
    </div>

    <div class="container">

        <div class="header" style="display: flex; justify-content: space-between; align-items: center; padding: 10px 20px;">
            <div>
                <h1 style="margin: 0;">CASINO Hawkeye Dashboard</h1>
                <p id="current-project-name" style="margin: 5px 0 0 0; font-size: 0.9em; opacity: 0.9;">
                    Loading... | <span id="total-runs-inline">-</span> runs | <span id="archive-size-inline">-</span> MB
                </p>
            </div>
            <div style="display: flex; gap: 10px;">
                <button onclick="repairArchive()"
                        class="btn" style="white-space: nowrap; background: #f39c12;">
                    Repair Archive
                </button>
                <button onclick="window.location.href='/select-project'"
                        class="btn btn-secondary" style="white-space: nowrap;">
                    Change Project
                </button>
            </div>
        </div>
        <div class="view-mode-badge" id="view-mode-indicator" style="
            position: fixed;
            top: 80px;
            right: 20px;
            background: #3498db;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 9998;
            display: none;
        ">
            <span id="mode-text">NORMAL VIEW</span>
        </div>

        <div class="controls">


            <div class="filter-row">
                <div class="filter-group">
                    <label for="filter-run">Run Version:</label>
                    <div class="filter-dropdown">
                        <button class="filter-button" onclick="toggleFilterDropdown('run-version')" id="filter-run-btn">
                            All Run Versions
                        </button>
                        <div class="filter-dropdown-content" id="run-version-dropdown">
                            <input type="text" class="filter-search" placeholder="Search run versions..." onkeyup="filterDropdownItems('run-version')">
                            <div id="run-version-options"></div>
                            <div class="filter-actions">
                                <button type="button" onclick="selectAllFilterOptions('run-version')" class="select-all">Select All</button>
                                <button type="button" onclick="clearAllFilterOptions('run-version')" class="clear-all">Clear All</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="filter-group">
                    <label for="filter-user">User:</label>
                    <div class="filter-dropdown">
                        <button class="filter-button" onclick="toggleFilterDropdown('user')" id="filter-user-btn">
                            All Users
                        </button>
                        <div class="filter-dropdown-content" id="user-dropdown">
                            <input type="text" class="filter-search" placeholder="Search users..." onkeyup="filterDropdownItems('user')">
                            <div id="user-options"></div>
                            <div class="filter-actions">
                                <button type="button" onclick="selectAllFilterOptions('user')" class="select-all">Select All</button>
                                <button type="button" onclick="clearAllFilterOptions('user')" class="clear-all">Clear All</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="filter-group">
                    <label for="filter-block">Block:</label>
                    <div class="filter-dropdown">
                        <button class="filter-button" onclick="toggleFilterDropdown('block')" id="filter-block-btn">
                            All Blocks
                        </button>
                        <div class="filter-dropdown-content" id="block-dropdown">
                            <input type="text" class="filter-search" placeholder="Search blocks..." onkeyup="filterDropdownItems('block')">
                            <div id="block-options"></div>
                            <div class="filter-actions">
                                <button type="button" onclick="selectAllFilterOptions('block')" class="select-all">Select All</button>
                                <button type="button" onclick="clearAllFilterOptions('block')" class="clear-all">Clear All</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="filter-group">
                    <label for="filter-dk">DK Ver/Tag:</label>
                    <div class="filter-dropdown">
                        <button class="filter-button" onclick="toggleFilterDropdown('dk')" id="filter-dk-btn">
                            All DK Versions
                        </button>
                        <div class="filter-dropdown-content" id="dk-dropdown">
                            <input type="text" class="filter-search" placeholder="Search DK versions..." onkeyup="filterDropdownItems('dk')">
                            <div id="dk-options"></div>
                            <div class="filter-actions">
                                <button type="button" onclick="selectAllFilterOptions('dk')" class="select-all">Select All</button>
                                <button type="button" onclick="clearAllFilterOptions('dk')" class="clear-all">Clear All</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <button class="btn btn-secondary" onclick="clearFilters()">Clear Filters</button>

            <!-- Table action buttons with search positioned on the right -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px; flex-wrap: wrap; gap: 10px;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <label style="font-weight: normal; color: #2c3e50; font-size: 10px;" title="Use ',' for OR, '+' for AND, '!' or '-' for NOT">Filter Run Version:</label>
                    <input type="text" id="run-version-search" placeholder="e.g., PI+PD, !error (OR, AND, NOT)"
                           style="padding: 2px 6px; border: 1px solid #ccc; border-radius: 3px; font-size: 10px; width: 200px;"
                           oninput="filterByRunVersion()"
                           title="Use ',' for OR, '+' for AND, '!' or '-' for NOT/exclude. Examples: 'PI' | 'PI, FE' | 'PI+PD' | '!error' | 'timing,!error'">
                </div>
                <div style="display: flex; gap: 8px;">
                    <button onclick="selectAllRuns()" class="btn" style="background: #2c3e50; white-space: nowrap; font-size: 10px; padding: 4px 8px;">
                    Select All
                </button>
                <button onclick="compareSelectedRuns()" class="btn" style="background: #c0392b; white-space: nowrap; font-size: 10px; padding: 4px 8px;">
                    Compare
                </button>
                <button onclick="exportSelectedRuns()" class="btn" style="background: #2980b9; white-space: nowrap; font-size: 10px; padding: 4px 8px;">
                    Export Selected
                </button>
            </div>
        </div>

        <!-- Table View -->
        <div id="table-view" class="data-table">
            <div id="loading" class="loading">Loading data...</div>
            <div id="runs-table"></div>
        </div>

        <!-- Graph View -->
        <div id="graph-view" class="graph-container" style="display: none;">
            <div id="graph-loading" class="loading">Loading graph...</div>
            <div id="graph-controls" style="margin-bottom: 15px; display: none;">
                <button class="btn" onclick="resetGraphView()">Reset View</button>
                <button class="btn" onclick="exportGraphImage()">Export Image</button>
                <button class="btn" onclick="testGraph()" style="background: #e67e22;">Debug</button>
                <span id="graph-info" style="margin-left: 15px; color: #666; font-size: 10px;"></span>
            </div>
            <div id="graph-canvas" style="width: 100%; height: 70vh; border: 1px solid #ddd; background: #f8f9fa;"></div>
        </div>

        <!-- Comparison Section -->
        <div id="comparison-section" style="display: none; margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
            <h3 style="color: #2c3e50; margin-bottom: 20px;">Keyword Comparison</h3>
            <div id="comparison-content"></div>
        </div>

        <div class="footer">
            <p>CASINO Hawkeye Analysis Dashboard - Powered by Flask & SQLite</p>
            <p>Last updated: <span id="last-update">-</span></p>
        </div>
    </div>

    <!-- Load JavaScript files in correct dependency order -->
    <script src="/static/js/utils.js"></script>
    <script src="/static/js/grouping.js"></script>
    <script src="/static/js/modal.js"></script>
    <script src="/static/js/dashboard.js"></script>

    <!-- D3.js for graph visualization -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
        // Check if D3.js loaded successfully
        if (typeof d3 === 'undefined') {
            console.warn('D3.js failed to load from CDN, trying alternative source...');
            // Try alternative CDN
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js';
            script.onload = function() {
                console.log('D3.js loaded from alternative CDN');
            };
            script.onerror = function() {
                console.warn('D3.js failed to load from all CDNs, using fallback visualization');
            };
            document.head.appendChild(script);
        }
    </script>

    <!-- html2canvas for graph export -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <!-- Minimal D3.js fallback if CDN fails -->
    <script>
        // Create a minimal D3.js-like object if the real D3.js fails to load
        if (typeof d3 === 'undefined') {
            console.log('Creating minimal D3.js fallback');
            window.d3 = {
                forceSimulation: function(nodes) {
                    return {
                        force: function() { return this; },
                        on: function() { return this; }
                    };
                },
                forceLink: function() {
                    return {
                        id: function() { return this; },
                        distance: function() { return this; }
                    };
                },
                forceManyBody: function() {
                    return {
                        strength: function() { return this; }
                    };
                },
                forceCenter: function() { return {}; },
                forceCollide: function() {
                    return {
                        radius: function() { return this; }
                    };
                },
                select: function() {
                    return {
                        selectAll: function() {
                            return {
                                data: function() {
                                    return {
                                        enter: function() {
                                            return {
                                                append: function() {
                                                    return {
                                                        attr: function() { return this; },
                                                        style: function() { return this; },
                                                        on: function() { return this; },
                                                        text: function() { return this; }
                                                    };
                                                }
                                            };
                                        }
                                    };
                                }
                            };
                        }
                    };
                }
            };
        }
    </script>
</body>
</html>

